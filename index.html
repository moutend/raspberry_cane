<html>
  <head>
    <script type="text/javascript">

window.onload = function() {
  var get = function(url) {
    return new Promise(function(resolve, reject) {
      var req = new XMLHttpRequest()

      req.open('GET', url)
      req.onload = function() {
        if (req.status == 200) {
          resolve(req.response);
        }
        else {
          reject(Error(req.statusText))
        }
      }
      req.onerror = function() {
        reject(Error("Network Error"))
      }
      req.send()
    })
  }
  var getJSON = function (url) {
     return get(url).then(JSON.parse)
  }

  var canvas = document.querySelector('#canvas')
  if (!canvas.getContext) {
    return
  }
  var color_scheme = {
    blue:  "#3498db",
    yellow: "#f1c40f",
    red:   "#e74c3c"
  }
  var ctx = canvas.getContext("2d")
  var dom_distance = document.querySelector("#distance")
  var dom_wrapper = document.querySelector("#wrapper")
  var show = function(distance) {
    dom_distance.innerHTML = distance
    if (distance <= 50) {
      dom_wrapper.style.backgroundColor = color_scheme.red
    }
    else if (distance <= 100) {
      dom_wrapper.style.backgroundColor = color_scheme.yellow
    }
    else {
      dom_wrapper.style.backgroundColor = color_scheme.blue
    }
  }
  var __width = 8.0
  var plot = function(element, index) {
    ctx.beginPath()
    ctx.lineCop = "round"
    ctx.strokeStyle = "black"
    ctx.moveTo(index * __width, 0)
    ctx.lineWidth = __width
    ctx.lineTo(index * __width, Math.floor(element))
    ctx.stroke()
    ctx.closePath()
  }
  var display = function(distance, data) {
    show(distance)
    if (data.length >= 960 / __width) {
      data.shift()
    }
    data.push(distance)
    data.forEach(plot)
    return data
  }
  var kick = function(elem, data) {
    setTimeout(function() {
      getJSON("/data.json")
      .then(function(responce) {
        var distance = parseInt(responce.Distance)
        ctx.clearRect(0, 0, canvas.width, canvas.height)
        data = display(distance %% 240, data)
        kick(elem, data)
      }, function(err) {
        console.info(err)
      })
    }, 50)
  }
  var elem = document.querySelector("#distance")
  kick(elem, [])
}
    </script>
  </head>
  <style>
* {
  margin: 0;
  padding: 0;
}
.code {
  font-family: "Liberation Mono", Consolas, Courier, monospace, sans-serif;
}
#distance {
  font-size: 212px;
}
#unit {
  padding: 0 16%% 0 4%%;
  font-size: 144px;
}
#wrapper {
  width: 980px;
  height: 240px;
  background-color: #AAA;
  color: #FFF;
  text-align: right;
  text-shadow: 0 0 160px #000;
  line-height: 240px;
}
  </style>
  <body>
    <div id="wrapper">
      <span class="code" id="distance">123</span>
      <span class="code" id="unit">cm</span>
    </div>
    <canvas id="canvas" width="960px" height="240px">
      Use Chrome or safari.
    </canvas>
  </body>
</html>
